# InvokeBuild + Git Worktrees for Parallel AI Development

This is a **sophisticated parallel development pattern** where multiple AI coding tools work simultaneously without conflicts. Let me break it down:

---

## The Problem: AI Tools Fighting Over Files

**Scenario:** You want multiple AI assistants working on your code at once:

```
Your Project/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ frontend/    ‚Üê Claude Code working here
‚îÇ   ‚îú‚îÄ‚îÄ backend/     ‚Üê Aider working here
‚îÇ   ‚îî‚îÄ‚îÄ tests/       ‚Üê Codex working here
```

**Problems:**
‚ùå **File conflicts** - All tools editing the same files  
‚ùå **Git chaos** - Tools overwriting each other's commits  
‚ùå **Branch confusion** - Can't track what tool did what  
‚ùå **Can't run in parallel** - Tools would corrupt each other's work  

---

## The Solution: Git Worktrees

### What is a Git Worktree?

A **git worktree** creates **multiple working directories** from the **same repository**. Think of it like cloning your repo multiple times, but they all share the same Git history.

**Normal Git:**
```
my-project/          ‚Üê One working directory
‚îú‚îÄ‚îÄ .git/
‚îú‚îÄ‚îÄ src/
‚îî‚îÄ‚îÄ tests/
```

**With Worktrees:**
```
my-project/          ‚Üê Main worktree
‚îú‚îÄ‚îÄ .git/
‚îú‚îÄ‚îÄ src/
‚îî‚îÄ‚îÄ tests/

my-project-claude/   ‚Üê Claude's worktree (branch: feature/claude)
‚îú‚îÄ‚îÄ src/
‚îî‚îÄ‚îÄ tests/

my-project-aider/    ‚Üê Aider's worktree (branch: feature/aider)
‚îú‚îÄ‚îÄ src/
‚îî‚îÄ‚îÄ tests/

my-project-codex/    ‚Üê Codex's worktree (branch: feature/codex)
‚îú‚îÄ‚îÄ src/
‚îî‚îÄ‚îÄ tests/
```

**Each worktree:**
- ‚úÖ Has its own files (no conflicts!)
- ‚úÖ On its own branch (no Git chaos!)
- ‚úÖ Shares Git history (same repo!)
- ‚úÖ Can work simultaneously (parallel!)

---

## How InvokeBuild Orchestrates This

Here's how you'd use **InvokeBuild** to manage parallel AI development with worktrees:

### Example Build Script

```powershell
# ai-parallel-dev.ps1

# Configuration
$MainRepo = "C:\projects\my-app"
$WorktreeBase = "C:\projects\worktrees"

# Task: Create isolated worktrees for each AI tool
task CreateWorktrees {
    $tools = @(
        @{ Name = "claude"; Branch = "feature/claude-frontend" },
        @{ Name = "aider";  Branch = "feature/aider-backend" },
        @{ Name = "codex";  Branch = "feature/codex-tests" }
    )
    
    foreach ($tool in $tools) {
        $worktreePath = Join-Path $WorktreeBase $tool.Name
        
        # Create worktree if it doesn't exist
        if (-not (Test-Path $worktreePath)) {
            Write-Host "Creating worktree for $($tool.Name)..." -ForegroundColor Cyan
            
            # Create new branch and worktree
            git worktree add $worktreePath -b $tool.Branch
            
            Write-Host "  ‚úì Worktree created: $worktreePath" -ForegroundColor Green
            Write-Host "  ‚úì Branch: $($tool.Branch)" -ForegroundColor Green
        } else {
            Write-Host "  ‚Üí Worktree already exists: $worktreePath" -ForegroundColor Yellow
        }
    }
}

# Task: Run Claude Code in its worktree
task RunClaude CreateWorktrees, {
    $worktreePath = Join-Path $WorktreeBase "claude"
    
    Write-Host "`nStarting Claude Code in isolated worktree..." -ForegroundColor Cyan
    
    # Run Claude Code in its own worktree
    Start-Job -Name "Claude" -ScriptBlock {
        param($path)
        Set-Location $path
        
        # Claude works on frontend
        claude --prompt "Implement the user dashboard component" `
               --files "src/frontend/**/*.tsx"
    } -ArgumentList $worktreePath
    
    Write-Host "  ‚úì Claude Code started (Job ID: $($job.Id))" -ForegroundColor Green
}

# Task: Run Aider in its worktree
task RunAider CreateWorktrees, {
    $worktreePath = Join-Path $WorktreeBase "aider"
    
    Write-Host "`nStarting Aider in isolated worktree..." -ForegroundColor Cyan
    
    # Run Aider in its own worktree
    Start-Job -Name "Aider" -ScriptBlock {
        param($path)
        Set-Location $path
        
        # Aider works on backend
        aider --message "Add user authentication API endpoints" `
              --files "src/backend/**/*.py"
    } -ArgumentList $worktreePath
    
    Write-Host "  ‚úì Aider started (Job ID: $($job.Id))" -ForegroundColor Green
}

# Task: Run Codex in its worktree
task RunCodex CreateWorktrees, {
    $worktreePath = Join-Path $WorktreeBase "codex"
    
    Write-Host "`nStarting Codex in isolated worktree..." -ForegroundColor Cyan
    
    # Run Codex in its own worktree
    Start-Job -Name "Codex" -ScriptBlock {
        param($path)
        Set-Location $path
        
        # Codex works on tests
        codex generate-tests --input "src/**/*.ts" `
              --output "tests/"
    } -ArgumentList $worktreePath
    
    Write-Host "  ‚úì Codex started (Job ID: $($job.Id))" -ForegroundColor Green
}

# Task: Run all AI tools in parallel
task ParallelDev RunClaude, RunAider, RunCodex, {
    Write-Host "`n========================================" -ForegroundColor Magenta
    Write-Host "All AI Tools Running in Parallel" -ForegroundColor Magenta
    Write-Host "========================================" -ForegroundColor Magenta
    
    # Monitor the jobs
    Write-Host "`nMonitoring parallel execution..." -ForegroundColor Cyan
    
    while (Get-Job | Where-Object { $_.State -eq 'Running' }) {
        $jobs = Get-Job
        foreach ($job in $jobs) {
            $status = if ($job.State -eq 'Running') { 'üîÑ' } else { '‚úì' }
            Write-Host "  $status $($job.Name): $($job.State)" -ForegroundColor Gray
        }
        Start-Sleep -Seconds 5
        Clear-Host
    }
    
    Write-Host "`n‚úì All AI tools completed!" -ForegroundColor Green
}

# Task: Collect changes from all worktrees
task CollectChanges ParallelDev, {
    Write-Host "`n========================================" -ForegroundColor Cyan
    Write-Host "Collecting Changes from Worktrees" -ForegroundColor Cyan
    Write-Host "========================================`n" -ForegroundColor Cyan
    
    $worktrees = @("claude", "aider", "codex")
    
    foreach ($tool in $worktrees) {
        $worktreePath = Join-Path $WorktreeBase $tool
        
        Write-Host "[$tool]" -ForegroundColor Yellow
        
        # Check what changed
        Push-Location $worktreePath
        
        $changes = git status --short
        if ($changes) {
            Write-Host "  Changes detected:" -ForegroundColor Green
            git status --short | ForEach-Object { Write-Host "    $_" -ForegroundColor Gray }
            
            # Commit changes
            git add .
            git commit -m "[$tool] Automated changes from AI assistant"
            
            Write-Host "  ‚úì Changes committed" -ForegroundColor Green
        } else {
            Write-Host "  ‚Üí No changes" -ForegroundColor Gray
        }
        
        Pop-Location
        Write-Host ""
    }
}

# Task: Merge via merge queue (simulate)
task MergeQueue CollectChanges, {
    Write-Host "`n========================================" -ForegroundColor Cyan
    Write-Host "Merge Queue Processing" -ForegroundColor Cyan
    Write-Host "========================================`n" -ForegroundColor Cyan
    
    $branches = @("feature/claude-frontend", "feature/aider-backend", "feature/codex-tests")
    
    Set-Location $MainRepo
    git checkout main
    
    foreach ($branch in $branches) {
        Write-Host "Merging $branch..." -ForegroundColor Cyan
        
        # Test merge first
        $mergeTest = git merge --no-commit --no-ff $branch 2>&1
        
        if ($LASTEXITCODE -eq 0) {
            # No conflicts, complete the merge
            git merge --no-ff $branch -m "Merge $branch via AI parallel development"
            Write-Host "  ‚úì Merged successfully" -ForegroundColor Green
        } else {
            # Conflicts detected
            Write-Host "  ‚ö† Conflicts detected - manual resolution needed" -ForegroundColor Yellow
            git merge --abort
            
            # Add to merge train for manual review
            Write-Host "  ‚Üí Added to manual merge queue" -ForegroundColor Yellow
        }
        
        Write-Host ""
    }
}

# Task: Cleanup worktrees
task Cleanup {
    Write-Host "`nCleaning up worktrees..." -ForegroundColor Cyan
    
    $worktrees = @("claude", "aider", "codex")
    
    foreach ($tool in $worktrees) {
        $worktreePath = Join-Path $WorktreeBase $tool
        
        if (Test-Path $worktreePath) {
            git worktree remove $worktreePath --force
            Write-Host "  ‚úì Removed worktree: $tool" -ForegroundColor Green
        }
    }
}

# Default: Run everything
task . ParallelDev, CollectChanges, MergeQueue
```

---

## How It Works Step-by-Step

### 1. **Create Isolated Worktrees**

```powershell
Invoke-Build CreateWorktrees
```

**What happens:**
```
C:\projects\worktrees\
‚îú‚îÄ‚îÄ claude\          ‚Üê Branch: feature/claude-frontend
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îú‚îÄ‚îÄ aider\           ‚Üê Branch: feature/aider-backend
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îî‚îÄ‚îÄ codex\           ‚Üê Branch: feature/codex-tests
    ‚îú‚îÄ‚îÄ src/
    ‚îî‚îÄ‚îÄ tests/
```

**Each worktree is:**
- On its own branch
- Isolated from the others
- Ready for parallel work

---

### 2. **Run AI Tools in Parallel**

```powershell
Invoke-Build ParallelDev
```

**Visual representation:**

```
Main Thread (InvokeBuild)
    ‚îú‚îÄ‚Üí Job 1: Claude Code
    ‚îÇ   ‚îî‚îÄ‚Üí Working in worktrees/claude/
    ‚îÇ       ‚îî‚îÄ‚Üí Branch: feature/claude-frontend
    ‚îÇ           ‚îî‚îÄ‚Üí Files: src/frontend/**/*.tsx
    ‚îÇ
    ‚îú‚îÄ‚Üí Job 2: Aider  
    ‚îÇ   ‚îî‚îÄ‚Üí Working in worktrees/aider/
    ‚îÇ       ‚îî‚îÄ‚Üí Branch: feature/aider-backend
    ‚îÇ           ‚îî‚îÄ‚Üí Files: src/backend/**/*.py
    ‚îÇ
    ‚îî‚îÄ‚Üí Job 3: Codex
        ‚îî‚îÄ‚Üí Working in worktrees/codex/
            ‚îî‚îÄ‚Üí Branch: feature/codex-tests
                ‚îî‚îÄ‚Üí Files: tests/**/*.ts
```

**All three AI tools work simultaneously without interfering!**

---

### 3. **Monitor Progress**

InvokeBuild monitors all parallel jobs:

```
Monitoring parallel execution...
  üîÑ Claude: Running
  üîÑ Aider: Running  
  üîÑ Codex: Running

[5 seconds later]

  ‚úì Claude: Completed
  üîÑ Aider: Running
  üîÑ Codex: Running

[5 seconds later]

  ‚úì Claude: Completed
  ‚úì Aider: Completed
  ‚úì Codex: Completed
```

---

### 4. **Collect Changes**

```powershell
Invoke-Build CollectChanges
```

Each worktree's changes are committed to its branch:

```
[claude]
  Changes detected:
    M  src/frontend/Dashboard.tsx
    A  src/frontend/UserProfile.tsx
  ‚úì Changes committed

[aider]
  Changes detected:
    M  src/backend/auth.py
    A  src/backend/user_api.py
  ‚úì Changes committed

[codex]
  Changes detected:
    A  tests/dashboard.test.ts
    A  tests/auth.test.ts
  ‚úì Changes committed
```

---

### 5. **Merge via Queue**

```powershell
Invoke-Build MergeQueue
```

**Merge Train Pattern:**

```
main ‚Üê‚îÄ feature/claude-frontend  ‚úì Merged
     ‚Üê‚îÄ feature/aider-backend    ‚úì Merged
     ‚Üê‚îÄ feature/codex-tests      ‚úì Merged
```

InvokeBuild merges each branch sequentially:
1. Test merge (check for conflicts)
2. If clean ‚Üí merge
3. If conflicts ‚Üí add to manual review queue

---

## Real-World Workflow Example

### Morning: Start Parallel Development

```powershell
# Create worktrees and start all AI tools
Invoke-Build ParallelDev
```

**Terminal output:**
```
Creating worktree for claude...
  ‚úì Worktree created: C:\projects\worktrees\claude
  ‚úì Branch: feature/claude-frontend

Creating worktree for aider...
  ‚úì Worktree created: C:\projects\worktrees\aider
  ‚úì Branch: feature/aider-backend

Creating worktree for codex...
  ‚úì Worktree created: C:\projects\worktrees\codex
  ‚úì Branch: feature/codex-tests

Starting Claude Code in isolated worktree...
  ‚úì Claude Code started (Job ID: 1)

Starting Aider in isolated worktree...
  ‚úì Aider started (Job ID: 2)

Starting Codex in isolated worktree...
  ‚úì Codex started (Job ID: 3)

========================================
All AI Tools Running in Parallel
========================================
```

### Afternoon: Collect and Merge

```powershell
# Wait for tools to finish, then integrate
Invoke-Build CollectChanges, MergeQueue
```

**Terminal output:**
```
========================================
Collecting Changes from Worktrees
========================================

[claude]
  Changes detected:
    M  src/frontend/Dashboard.tsx
    A  src/frontend/components/UserCard.tsx
  ‚úì Changes committed

[aider]
  Changes detected:
    M  src/backend/api/users.py
    A  src/backend/api/auth.py
  ‚úì Changes committed

[codex]
  Changes detected:
    A  tests/integration/auth.test.ts
    A  tests/unit/users.test.ts
  ‚úì Changes committed

========================================
Merge Queue Processing
========================================

Merging feature/claude-frontend...
  ‚úì Merged successfully

Merging feature/aider-backend...
  ‚úì Merged successfully

Merging feature/codex-tests...
  ‚úì Merged successfully
```

---

## Advanced: Conflict Resolution

### Scenario: Two tools modify the same file

```powershell
task MergeWithConflictResolution CollectChanges, {
    $branches = @("feature/claude-frontend", "feature/aider-backend")
    
    Set-Location $MainRepo
    git checkout main
    
    foreach ($branch in $branches) {
        Write-Host "Attempting merge: $branch" -ForegroundColor Cyan
        
        # Try merge
        git merge --no-commit --no-ff $branch 2>&1 | Out-Null
        
        if ($LASTEXITCODE -ne 0) {
            Write-Host "  ‚ö† Conflicts detected!" -ForegroundColor Yellow
            
            # Show conflicts
            $conflicts = git diff --name-only --diff-filter=U
            Write-Host "  Conflicting files:" -ForegroundColor Red
            $conflicts | ForEach-Object { Write-Host "    - $_" -ForegroundColor Red }
            
            # Abort this merge
            git merge --abort
            
            # Strategy: Keep both changes in separate commits
            Write-Host "  ‚Üí Adding to manual resolution queue" -ForegroundColor Yellow
            
            # Create merge ticket
            $ticket = @{
                Branch = $branch
                Conflicts = $conflicts
                Timestamp = Get-Date
            }
            
            # Export to JSON for review
            $ticket | ConvertTo-Json | Out-File "merge-queue/$branch.json"
            
        } else {
            # Clean merge
            git merge --no-ff $branch -m "Merge $branch"
            Write-Host "  ‚úì Merged successfully" -ForegroundColor Green
        }
    }
}
```

---

## Benefits of This Approach

### 1. **No File Races**
```
‚ùå Without worktrees:
Claude edits file.tsx  ‚Üí Saves
Aider edits file.tsx   ‚Üí Overwrites Claude's work!

‚úÖ With worktrees:
Claude edits worktrees/claude/file.tsx
Aider edits worktrees/aider/file.tsx
(Different files, no conflict!)
```

### 2. **Clean Git History**
```
main
‚îú‚îÄ feature/claude-frontend (Claude's work)
‚îú‚îÄ feature/aider-backend (Aider's work)
‚îî‚îÄ feature/codex-tests (Codex's work)

Each tool's contribution is clearly tracked!
```

### 3. **True Parallelism**
```
Sequential (slow):
Claude: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà (5 min)
Aider:          ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà (5 min)
Codex:                  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà (5 min)
Total: 15 minutes

Parallel (fast):
Claude: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
Aider:  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
Codex:  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
Total: 5 minutes (3x faster!)
```

### 4. **Easy Rollback**
```powershell
# Claude's changes bad? Just don't merge that branch
git branch -D feature/claude-frontend

# Or merge only what you want
Invoke-Build MergeQueue -Branches "feature/aider-backend","feature/codex-tests"
```

---

## Summary

**InvokeBuild + Git Worktrees** enables:

‚úÖ **Multiple AI tools working simultaneously**  
‚úÖ **Each tool in isolated environment** (worktree + branch)  
‚úÖ **No file conflicts** (different directories)  
‚úÖ **Clean integration** (merge queue/train)  
‚úÖ **Orchestrated by InvokeBuild** (tasks, dependencies, parallel jobs)  

**The pattern:**
1. InvokeBuild creates isolated worktrees
2. Launches AI tools in parallel (PowerShell jobs)
3. Each tool works independently
4. InvokeBuild collects changes
5. Merges via queue (handles conflicts)
6. Clean, traceable Git history

It's like having **multiple developers** working on different branches simultaneously, but they're AI coding assistants! ü§ñüöÄ